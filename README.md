![title](data/img/title.png)
## 概要
タイピング入力だけでキャラクターを操作するアクションゲームです。
本ゲームは機械学習を用いることでキャラクターと雑談を行うことも可能となっています。
実行形式での配布はまだできていません。

![demo](https://user-images.githubusercontent.com/38200445/71111849-9ea8c000-220d-11ea-87a8-01f964b8a39d.gif)

なお、このプログラム群は以下の3つの要素を合わせたものであり、すべて実行することでゲームを起動できる状態となります。
1. Twitterから不特定話者の対話データを収集する
2. 対話データを用いて雑談対話モデルを機械学習する
3. 雑談対話モデルを搭載してゲームを実行する

## ゲーム内容
1. タイトル画面
タイピングしてエンターキーを押すとキャラクターに話しかけることができます。
a-z以外にも、"！","？","、","ー"を入力できます。
"！"と"？"の入力にはShift押しは必要ありません。
"はじめる"と入力することでゲームを開始できます。
"おわる"と入力することでゲームを終了できます。
それ以外を入力することでキャラクターとの雑談が可能です。
2. ゲームプレイ画面
現状では、左右移動と停止の行動命令が可能です。
"みぎにすすんで"、"ひだりにいって！"、"すとっぷ！"、"とまれ"などに反応できます。
ステージは自動生成されますが、当たり判定は未実装です。
ウィンドウを閉じることでゲームを終了できます。
また、この画面でも雑談を行うことができます。

## 構成
```
.
├─config/               ... 各種設定やパラメータ
│  ├─ai_config.yml      ... 機械学習パラメータ
│  ├─api_key_sample.yml ... Twitter API Keyの記述例
│  ├─data_config.yml    ... 各種ファイルパス
│  └─twitter_config.yml ... Twitter対話データ収集先のパス
├─data/                 ... 読み書きするデータ群
│  ├─corpus/            ... Twitter対話データ収集先
│  ├─font/              ... フォントファイル
│  ├─img/               ... ゲームに用いる画像群
│  ├─model/             ... 機械学習した対話モデル保存先
│  ├─system/            ... ゲーム内の文字入力に関するデータ
│  │  ├─pattern.txt     ... 命令パターン(数字はsynonym.txtに対応する)
│  │  ├─romaji.txt      ... ローマ字入力のための対応表
│  │  └─synonym.txt     ... ゲーム的に同義な表記をまとめた表
│  └─text/              ... ゲーム内で用いるテキスト群
│     ├─title.txt       ... タイトル画面でのセリフ
│     ├─start.txt       ... ゲームスタート時のセリフ候補
│     └─end.txt         ... ゲーム終了時のセリフ候補
├─doc/                  ... ドキュメント群
│  └─langame.pdf        ... ゲームの企画書
├─src/                  ... ゲームに用いるスクリプト群
│  ├─utils/             ... よく呼び出されるスクリプト群
│  │  ├─__init__.py
│  │  ├─back.py         ... 背景演出クラス
│  │  ├─balloon.py      ... セリフの吹き出しクラス
│  │  ├─match.py        ... 命令パターンマッチングクラス
│  │  ├─me.py           ... 操作キャラクタークラス
│  │  └─text.txt        ... テキスト描画クラス
│  ├─__init__.py
│  ├─key.py             ... キーボード入力検知クラス
│  ├─manager.py         ... ゲームを管理するクラス群
│  ├─play.py            ... ゲームプレイ画面の処理クラス
│  ├─title.py           ... タイトル画面の処理クラス
│  └─user.py            ... プレイヤーの入力を管理するクラス
├─twitter.py            ... Twitterの不特定話者対話データ収集スクリプト
├─ai.py                 ... 機械学習による雑談対話モデル学習スクリプト
└─main.py               ... ゲームを起動し管理するスクリプト
```
## 要件
- Python3系
- pyyaml
- Twitterから不特定話者の対話データを収集するために必要
    - tweepy
    - MeCab
- 対話データを用いて雑談対話モデルを機械学習するために必要
    - Pytorch4.0以上
    - numpy
- 雑談対話モデルを搭載してゲームを実行するために必要
    - Pytorch4.0以上
    - numpy
    - Pygame

## 実行方法
- Twitterから不特定話者の対話データを収集する
    1. Twitter APIを取得する
    2. "config/api_key_sample.yml"を参考にして、"config/api_key.yml"を作成し、取得したTwitter API Keyを書き込む
    3. $ python twitter.pyと実行すると、"data/corpus/"内に対話データがリアルタイムに収集されていく
    4. Ctrl+C入力により収集を停止できる(十分に学習するためにはおよそ10万データ必要だが、指定はない)
- 対話データを用いて雑談対話モデルを機械学習する
    1. "data/corpus/"内に対話データが収集されていることを確認する
    2. $ python ai.py -m trainもしくは$ python ai.pyと実行すると、雑談対話モデルの学習が開始する
    3. Ctrl+C入力により学習を停止でき、"data/model/"内に雑談対話モデルが保存される
    4. $ python ai.py -m testと実行することで学習済み雑談対話モデルをテストすることができる
    5. 学習パラメータ等は"config/ai_config.yml"で変更できる(詳細は後述)
    6. GPU上で実行することで処理速度を大幅に上げることができる
- 雑談対話モデルを搭載してゲームを実行する
    1. "data/model/"内に学習済み雑談対話モデルが保存されていることを確認する
    2. $ python main.pyと実行するとゲームが起動する

## 設定
"config/ai_config.yml"で変更できる各種学習パラメータの詳細を記述します。
```
path:
    inp     : 学習に使用する対話データの入力文のファイルパス
    tar     : 学習に使用する対話データの目標文のファイルパス
    encoder : 保存する雑談対話モデルのエンコーダ部のファイルパス
    decoder : 保存する雑談対話モデルのデコーダ部のファイルパス

cuda: GPUで動かす場合の割当て番号

model:
    hidden  : 隠れユニット数(推奨:128~256)
    layer   : 層数(推奨:1~3)
    dropout : ドロップアウト率(推奨:0.0~0.2)

train:
    use_corpus_size : 収集した対話データのうち使用する数(-1にすると全部使用)
    batch_size      : 一度に処理するデータ数(推奨:64~256)
    learning_rate   : 学習率(推奨:0.0001~0.001)
    max_epoch       : 最大学習回数(推奨:300~, 他パラメータによる)

test:
    beam_width  : 応答文生成時のビームサーチ幅(推奨:5~15)
    min_length  : 応答文の最小文字数(推奨:2~)
    max_length  : 応答文の最大文字数(推奨:10~20, min_lengthより大きく)
```
＊学習にはRNNを用いたSequence-to-sequenceモデルを使用しています。
